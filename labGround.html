<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>เครื่องมือจำลองการต่อลงดิน (Grounding Simulator)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;700&display=swap');
        body { font-family: 'Sarabun', sans-serif; }
        
        /* Animation for the fault current path */
        @keyframes dash {
            to { stroke-dashoffset: -20; }
        }
        .current-flow {
            stroke-dasharray: 5;
            animation: dash 1s linear infinite;
        }
        .fade-enter {
            opacity: 0;
            transition: opacity 0.5s ease-in;
        }
        .fade-enter-active {
            opacity: 1;
        }
    </style>
</head>
<body class="bg-slate-100 text-slate-900 min-h-screen flex flex-col">

    <!-- Navbar -->
    <nav class="bg-blue-900 text-white p-4 shadow-lg">
        <div class="max-w-6xl mx-auto flex items-center justify-between">
            <div class="flex items-center gap-3">
                <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2v20M2 12h20M12 2a10 10 0 0 1 10 10 10 10 0 0 1-10 10 10 10 0 0 1-10-10 10 10 0 0 1 10-10z"/></svg>
                <h1 class="text-xl font-bold">Grounding Simulator</h1>
            </div>
            <div class="text-sm text-blue-200">สื่อการสอนวิชาการวิเคราะห์ระบบไฟฟ้ากำลัง</div>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto w-full p-4 md:p-8 flex-grow">
        
        <!-- Tab Controls -->
        <div class="flex justify-center mb-8">
            <div class="bg-white p-1 rounded-full shadow-md border border-slate-200 inline-flex">
                <button id="btn-grounding" onclick="setTab('grounding')" class="px-8 py-2 rounded-full transition-all font-bold bg-blue-600 text-white shadow-sm">
                    1. การต่อลงดิน (Grounding)
                </button>
                <button id="btn-insulation" onclick="setTab('insulation')" class="px-8 py-2 rounded-full transition-all font-bold text-slate-500 hover:bg-slate-50">
                    2. โคออร์ดิเนชันฉนวน (Insulation)
                </button>
            </div>
        </div>

        <!-- VIEW: GROUNDING -->
        <div id="view-grounding" class="grid grid-cols-1 lg:grid-cols-12 gap-6">
            
            <!-- Left Panel: Settings & Theory -->
            <div class="lg:col-span-4 space-y-6">
                <!-- Control Panel -->
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                    <h2 class="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2">
                        <span class="bg-blue-100 text-blue-700 p-1.5 rounded-lg"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg></span>
                        ตั้งค่ารูปแบบการต่อลงดิน
                    </h2>
                    
                    <div class="space-y-4">
                        <div onclick="selectType('solid')" id="opt-solid" class="cursor-pointer p-3 rounded-xl border-2 border-blue-500 bg-blue-50 transition-all hover:shadow-md flex items-center justify-between">
                            <span class="font-bold">1. Solidly Grounded</span>
                            <span class="text-xs bg-blue-200 text-blue-800 px-2 py-1 rounded">ต่อตรง</span>
                        </div>
                        <div onclick="selectType('resistance')" id="opt-resistance" class="cursor-pointer p-3 rounded-xl border-2 border-transparent hover:border-slate-300 bg-slate-50 transition-all hover:shadow-md flex flex-col gap-2">
                            <div class="flex items-center justify-between w-full">
                                <span class="font-bold">2. Resistance Grounded</span>
                                <span class="text-xs bg-orange-200 text-orange-800 px-2 py-1 rounded">ต่อผ่าน R</span>
                            </div>
                            <!-- Slider only shows when active -->
                            <div id="res-slider-container" class="hidden pt-2 border-t border-slate-200 mt-1">
                                <div class="flex justify-between text-sm mb-1">
                                    <span>ค่าความต้านทาน (R)</span>
                                    <span class="font-mono font-bold text-orange-600" id="res-val">10 Ω</span>
                                </div>
                                <input type="range" id="resistance-input" min="1" max="100" value="10" class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-orange-500" oninput="updateSimulation()">
                            </div>
                        </div>
                        <div onclick="selectType('isolated')" id="opt-isolated" class="cursor-pointer p-3 rounded-xl border-2 border-transparent hover:border-slate-300 bg-slate-50 transition-all hover:shadow-md flex items-center justify-between">
                            <span class="font-bold">3. Isolated Neutral</span>
                            <span class="text-xs bg-red-200 text-red-800 px-2 py-1 rounded">ไม่ต่อ (ลอย)</span>
                        </div>
                    </div>
                </div>

                <!-- Theory Box -->
                <div class="bg-gradient-to-br from-slate-800 to-slate-900 text-white p-6 rounded-2xl shadow-md">
                    <h3 class="text-lg font-bold mb-3 text-yellow-400">หลักการทำงาน</h3>
                    <p id="theory-desc" class="text-sm leading-relaxed text-slate-300">
                        เลือกรูปแบบการต่อลงดินด้านบนเพื่อดูคำอธิบาย...
                    </p>
                    <div class="mt-4 pt-4 border-t border-slate-700 grid grid-cols-2 gap-4 text-center">
                        <div>
                            <div class="text-xs text-slate-400">กระแส Fault</div>
                            <div id="metric-current" class="text-lg font-bold text-red-400">สูงมาก</div>
                        </div>
                        <div>
                            <div class="text-xs text-slate-400">แรงดันเฟสดี</div>
                            <div id="metric-voltage" class="text-lg font-bold text-green-400">ปกติ</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Panel: Visualization -->
            <div class="lg:col-span-8 flex flex-col gap-6">
                
                <!-- 1. Schematic Diagram (The Hero) -->
                <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden relative">
                    <div class="absolute top-4 left-4 bg-white/90 backdrop-blur px-3 py-1 rounded-lg border border-slate-200 text-xs font-bold text-slate-500 z-10">
                        แผนภาพวงจร (Circuit Schematic)
                    </div>
                    
                    <div class="flex justify-center items-center py-8 bg-slate-50">
                        <svg viewBox="0 0 600 350" class="w-full max-w-2xl h-auto drop-shadow-xl">
                            <defs>
                                <filter id="glow" x="-20%" y="-20%" width="140%" height="140%">
                                    <feGaussianBlur stdDeviation="2" result="blur" />
                                    <feComposite in="SourceGraphic" in2="blur" operator="over" />
                                </filter>
                            </defs>

                            <!-- Transformer Windings (Star) -->
                            <g transform="translate(300, 120)">
                                <!-- Center Neutral Point -->
                                <circle cx="0" cy="0" r="8" fill="#1e293b" stroke="white" stroke-width="2" />
                                <text x="15" y="5" font-size="14" font-weight="bold" fill="#334155">N (Neutral)</text>

                                <!-- Phase A (Top) -->
                                <line x1="0" y1="0" x2="0" y2="-80" stroke="#cbd5e1" stroke-width="6" stroke-linecap="round" />
                                <text x="-15" y="-90" font-size="14" font-weight="bold" fill="#94a3b8">Phase A</text>
                                <!-- Fault indicator -->
                                <g id="fault-indicator">
                                    <path d="M 0 -80 L -20 -100 L 0 -100 L -10 -120" fill="none" stroke="#ef4444" stroke-width="3">
                                        <animate attributeName="opacity" values="0;1;0" dur="0.8s" repeatCount="indefinite" />
                                    </path>
                                    <text x="10" y="-110" font-size="12" fill="#ef4444" font-weight="bold">FAULT!</text>
                                    <!-- Fault path to ground -->
                                    <path d="M 0 -80 L 150 -80 L 150 180" fill="none" stroke="#ef4444" stroke-width="2" stroke-dasharray="4" opacity="0.5" />
                                </g>

                                <!-- Phase B (Bottom Left) -->
                                <line x1="0" y1="0" x2="-69" y2="40" stroke="#3b82f6" stroke-width="6" stroke-linecap="round" />
                                <text x="-90" y="55" font-size="14" font-weight="bold" fill="#3b82f6">Phase B</text>

                                <!-- Phase C (Bottom Right) -->
                                <line x1="0" y1="0" x2="69" y2="40" stroke="#10b981" stroke-width="6" stroke-linecap="round" />
                                <text x="80" y="55" font-size="14" font-weight="bold" fill="#10b981">Phase C</text>
                            </g>

                            <!-- Ground Connection Area (Dynamic) -->
                            <g transform="translate(300, 120)">
                                <!-- The Connection Path -->
                                <line x1="0" y1="0" x2="0" y2="60" stroke="#334155" stroke-width="4" />
                                
                                <!-- CONNECTION TYPES -->
                                <g id="conn-display" transform="translate(0, 60)">
                                    <!-- 1. Solid Line -->
                                    <line id="draw-solid" x1="0" y1="0" x2="0" y2="120" stroke="#3b82f6" stroke-width="6" class="hidden" />

                                    <!-- 2. Resistor -->
                                    <g id="draw-resistor" class="hidden">
                                        <path d="M 0 0 L 0 20 L 15 30 L -15 50 L 15 70 L -15 90 L 0 100 L 0 120" fill="none" stroke="#f97316" stroke-width="4" stroke-linecap="round" stroke-linejoin="round" />
                                        <rect x="-25" y="20" width="50" height="80" fill="none" stroke="#f97316" stroke-width="1" stroke-dasharray="2" opacity="0.5"/>
                                        <text x="30" y="65" font-size="14" fill="#ea580c" font-weight="bold">R</text>
                                    </g>

                                    <!-- 3. Isolated (Open) -->
                                    <g id="draw-isolated" class="hidden">
                                        <line x1="0" y1="0" x2="-15" y2="40" stroke="#ef4444" stroke-width="4" stroke-linecap="round" />
                                        <line x1="0" y1="120" x2="0" y2="80" stroke="#334155" stroke-width="4" stroke-linecap="round" />
                                        <circle cx="0" cy="80" r="4" fill="#334155" />
                                        <text x="20" y="60" font-size="14" fill="#ef4444" font-weight="bold">OPEN</text>
                                        <text x="20" y="75" font-size="10" fill="#64748b">No Connection</text>
                                    </g>
                                </g>

                                <!-- Ground Symbol -->
                                <g transform="translate(0, 180)">
                                    <line x1="-30" y1="0" x2="30" y2="0" stroke="#334155" stroke-width="4" stroke-linecap="round" />
                                    <line x1="-20" y1="8" x2="20" y2="8" stroke="#334155" stroke-width="4" stroke-linecap="round" />
                                    <line x1="-10" y1="16" x2="10" y2="16" stroke="#334155" stroke-width="4" stroke-linecap="round" />
                                    <text x="40" y="10" font-size="14" font-weight="bold" fill="#475569">Ground (ดิน)</text>
                                </g>
                            </g>

                            <!-- Current Flow Animation (Only visible in Solid/Resistor) -->
                            <path id="anim-current" d="M 300 120 L 300 300" fill="none" stroke="#ef4444" stroke-width="2" class="current-flow hidden" opacity="0.6" />

                        </svg>
                    </div>
                </div>

                <!-- 2. Phasor Result -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                        <h4 class="font-bold text-slate-700 mb-4 text-center">แผนภาพเฟสเซอร์ (Phasor Diagram)</h4>
                        <div class="flex justify-center h-48">
                            <svg viewBox="0 0 200 200" class="w-48 h-48 overflow-visible">
                                <!-- Grid -->
                                <circle cx="100" cy="100" r="60" fill="none" stroke="#e2e8f0" stroke-dasharray="4" />
                                <circle cx="100" cy="100" r="104" fill="none" stroke="#e2e8f0" stroke-dasharray="4" />
                                <!-- Center Neutral -->
                                <circle id="phasor-n" cx="100" cy="100" r="3" fill="#334155" />
                                <!-- Vectors -->
                                <line id="vec-a" x1="100" y1="100" x2="100" y2="40" stroke="#cbd5e1" stroke-width="2" stroke-dasharray="2" /> <!-- Collapsed A -->
                                <line id="vec-b" x1="100" y1="100" x2="48" y2="130" stroke="#3b82f6" stroke-width="3" marker-end="url(#arrow-b)" />
                                <line id="vec-c" x1="100" y1="100" x2="152" y2="130" stroke="#10b981" stroke-width="3" marker-end="url(#arrow-c)" />
                                
                                <defs>
                                    <marker id="arrow-b" viewBox="0 0 10 10" refX="5" refY="5" markerWidth="4" markerHeight="4" orient="auto-start-reverse"><path d="M0 0L10 5L0 10z" fill="#3b82f6"/></marker>
                                    <marker id="arrow-c" viewBox="0 0 10 10" refX="5" refY="5" markerWidth="4" markerHeight="4" orient="auto-start-reverse"><path d="M0 0L10 5L0 10z" fill="#10b981"/></marker>
                                </defs>
                            </svg>
                        </div>
                    </div>

                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 flex flex-col justify-center">
                        <h4 class="font-bold text-slate-700 mb-2">ค่าแรงดัน (เทียบกับดิน)</h4>
                        <div class="space-y-3">
                            <div class="flex justify-between items-center p-2 bg-slate-50 rounded">
                                <span class="flex items-center gap-2"><div class="w-3 h-3 rounded-full bg-slate-300"></div> Phase A (Fault)</span>
                                <span class="font-mono font-bold text-slate-400">0.0 kV</span>
                            </div>
                            <div class="flex justify-between items-center p-2 bg-blue-50 rounded">
                                <span class="flex items-center gap-2"><div class="w-3 h-3 rounded-full bg-blue-500"></div> Phase B</span>
                                <span id="val-vb" class="font-mono font-bold text-blue-700">66.4 kV</span>
                            </div>
                            <div class="flex justify-between items-center p-2 bg-green-50 rounded">
                                <span class="flex items-center gap-2"><div class="w-3 h-3 rounded-full bg-green-500"></div> Phase C</span>
                                <span id="val-vc" class="font-mono font-bold text-green-700">66.4 kV</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- VIEW: INSULATION (Simplified for completeness) -->
        <div id="view-insulation" class="hidden">
            <div class="bg-white p-8 rounded-2xl shadow-sm border border-slate-200 text-center">
                <h2 class="text-2xl font-bold mb-4">Insulation Coordination Curve</h2>
                <div class="h-96 w-full relative">
                    <canvas id="insulationChart"></canvas>
                </div>
                <div class="mt-6 max-w-lg mx-auto space-y-4">
                    <label class="block text-sm font-medium text-slate-700">ปรับค่า Arrester LPL (kV)</label>
                    <input type="range" id="lpl-slider" min="200" max="600" value="400" class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-red-500" oninput="updateInsulation()">
                    <div class="flex justify-between text-sm font-bold">
                        <span>LPL: <span id="lpl-val" class="text-red-600">400</span> kV</span>
                        <span>Margin: <span id="margin-val" class="text-green-600">37.5%</span></span>
                    </div>
                </div>
            </div>
        </div>

    </main>

    <script>
        let currentType = 'solid';
        let chartInstance = null;

        // --- Grounding Logic ---
        function selectType(type) {
            currentType = type;
            
            // UI Styling for Buttons
            ['solid', 'resistance', 'isolated'].forEach(t => {
                const el = document.getElementById(`opt-${t}`);
                if (t === type) {
                    el.classList.add('border-blue-500', 'bg-blue-50');
                    el.classList.remove('border-transparent', 'bg-slate-50');
                } else {
                    el.classList.remove('border-blue-500', 'bg-blue-50');
                    el.classList.add('border-transparent', 'bg-slate-50');
                }
            });

            // Show slider only for resistance
            if(type === 'resistance') {
                document.getElementById('res-slider-container').classList.remove('hidden');
            } else {
                document.getElementById('res-slider-container').classList.add('hidden');
            }

            updateSimulation();
        }

        function updateSimulation() {
            const theoryDesc = document.getElementById('theory-desc');
            const metricCurrent = document.getElementById('metric-current');
            const metricVoltage = document.getElementById('metric-voltage');
            
            const drawSolid = document.getElementById('draw-solid');
            const drawResistor = document.getElementById('draw-resistor');
            const drawIsolated = document.getElementById('draw-isolated');
            const animCurrent = document.getElementById('anim-current');
            
            const valVb = document.getElementById('val-vb');
            const valVc = document.getElementById('val-vc');

            // Hide all visuals first
            drawSolid.classList.add('hidden');
            drawResistor.classList.add('hidden');
            drawIsolated.classList.add('hidden');
            animCurrent.classList.add('hidden');

            let voltage = 66.4;
            let displayVoltage = "66.4 kV";
            let vn_shift = 0; // 0 = Center, 1 = Full Shift

            if (currentType === 'solid') {
                drawSolid.classList.remove('hidden');
                animCurrent.classList.remove('hidden');
                
                theoryDesc.innerHTML = "<strong>Solidly Grounded:</strong> ต่อสายจากจุด Neutral ลงดินโดยตรงด้วยตัวนำขนาดใหญ่ <br>• ทำให้แรงดันเฟสดี (B, C) คงที่ ไม่พุ่งสูง <br>• แต่กระแสลัดวงจรจะไหลผ่านจุดนี้สะดวกมาก (กระแสสูง)";
                metricCurrent.textContent = "สูงมาก (High)";
                metricCurrent.className = "text-lg font-bold text-red-500";
                metricVoltage.textContent = "คงที่ (Stable)";
                metricVoltage.className = "text-lg font-bold text-green-500";
                
                voltage = 66.4;
                vn_shift = 0;

            } else if (currentType === 'resistance') {
                drawResistor.classList.remove('hidden');
                animCurrent.classList.remove('hidden'); // Current still flows, but less
                
                const rVal = document.getElementById('resistance-input').value;
                document.getElementById('res-val').textContent = rVal + " Ω";

                theoryDesc.innerHTML = `<strong>Resistance Grounded:</strong> ต่อผ่านตัวต้านทานขนาด ${rVal} โอห์ม <br>• ตัวต้านทานช่วย "ขวาง" กระแสไม่ให้ไหลลงดินเร็วเกินไป <br>• แรงดันเฟสดีจะสูงขึ้นบ้างตามค่าความต้านทาน`;
                metricCurrent.textContent = "ปานกลาง (Limited)";
                metricCurrent.className = "text-lg font-bold text-orange-500";
                metricVoltage.textContent = "สูงขึ้นเล็กน้อย";
                metricVoltage.className = "text-lg font-bold text-orange-500";

                // Simulate physics for visuals
                const factor = rVal / 100; // 0 to 1
                voltage = 66.4 * (1 + (0.732 * factor)); // Max sqrt(3) approx
                vn_shift = factor * 60; // Max shift pixels

            } else if (currentType === 'isolated') {
                drawIsolated.classList.remove('hidden');
                // No current animation
                
                theoryDesc.innerHTML = "<strong>Isolated Neutral:</strong> ลอยจุด Neutral ไว้ ไม่ต่อลงดิน <br>• ไม่มีเส้นทางให้กระแส Fault ไหลกลับครบวงจร (กระแสต่ำมาก) <br>• แต่จุด Neutral จะถูกดึงศักย์ไฟฟ้า ทำให้แรงดันเฟสดีพุ่งสูงเป็น √3 เท่า";
                metricCurrent.textContent = "ต่ำมาก (Low)";
                metricCurrent.className = "text-lg font-bold text-green-500";
                metricVoltage.textContent = "อันตราย (High)";
                metricVoltage.className = "text-lg font-bold text-red-500";

                voltage = 115.0; // Full line-to-line
                vn_shift = 60; // Full shift pixels
            }

            // Update Text Values
            valVb.textContent = voltage.toFixed(1) + " kV";
            valVc.textContent = voltage.toFixed(1) + " kV";

            // Update Phasor Visuals (Simple SVG Manipulation)
            const nPoint = document.getElementById('phasor-n');
            const vecB = document.getElementById('vec-b');
            const vecC = document.getElementById('vec-c');
            const vecA = document.getElementById('vec-a');

            // Move Neutral Point (Source) Up
            // Center is 100, 100. Max Up is 40.
            const newCy = 100 - vn_shift; 
            
            nPoint.setAttribute('cy', newCy);
            
            // A always connects N to Ground (Fault). Ground is fixed at 100,100 visually?
            // Actually in Fault analysis, V_ground is 0. 
            // If N shifts up to +Vn, then Va (relative to N) points down.
            // Let's keep it simple: Ground is the center of the chart (100,100).
            // N moves away from ground.
            
            vecA.setAttribute('y1', newCy); 
            vecA.setAttribute('y2', 100); // Ground

            // B & C start at N
            vecB.setAttribute('x1', 100);
            vecB.setAttribute('y1', newCy);
            vecC.setAttribute('x1', 100);
            vecC.setAttribute('y1', newCy);
            
            // Tips of B & C
            // Start positions (Solid): B(48, 130), C(152, 130) relative to (100,100) center
            // When N moves up (y decreases), the vectors are rigid with N.
            // So tips also move up by same amount?
            // No, phasors relative to ground change.
            // In Isolated fault: Vb_gnd = Vb_source + Vn_shift.
            // Vb_source is fixed relative to N.
            // So if N moves up (visual y decreases), the whole triangle moves up.
            
            const tipB_y = 130 - vn_shift;
            const tipC_y = 130 - vn_shift;
            
            vecB.setAttribute('y2', tipB_y);
            vecC.setAttribute('y2', tipC_y);
        }

        // --- Tab & Insulation Logic ---
        function setTab(tab) {
            if (tab === 'grounding') {
                document.getElementById('view-grounding').classList.remove('hidden');
                document.getElementById('view-insulation').classList.add('hidden');
                document.getElementById('btn-grounding').classList.add('bg-blue-600', 'text-white', 'shadow-sm');
                document.getElementById('btn-grounding').classList.remove('text-slate-500');
                document.getElementById('btn-insulation').classList.remove('bg-blue-600', 'text-white', 'shadow-sm');
                document.getElementById('btn-insulation').classList.add('text-slate-500');
            } else {
                document.getElementById('view-grounding').classList.add('hidden');
                document.getElementById('view-insulation').classList.remove('hidden');
                document.getElementById('btn-grounding').classList.remove('bg-blue-600', 'text-white', 'shadow-sm');
                document.getElementById('btn-grounding').classList.add('text-slate-500');
                document.getElementById('btn-insulation').classList.add('bg-blue-600', 'text-white', 'shadow-sm');
                document.getElementById('btn-insulation').classList.remove('text-slate-500');
                if(!chartInstance) initChart();
            }
        }

        function initChart() {
            const ctx = document.getElementById('insulationChart').getContext('2d');
            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [0, 1, 2, 8, 20],
                    datasets: [
                        { label: 'Arrester Voltage (LPL)', data: [0, 200, 400, 400, 0], borderColor: '#ef4444', borderWidth: 3, tension: 0.1, fill: false },
                        { label: 'Equipment BIL (550 kV)', data: [550, 550, 550, 550, 550], borderColor: '#10b981', borderWidth: 2, borderDash: [5, 5], pointRadius: 0 }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true, max: 800 } }
                }
            });
        }

        function updateInsulation() {
            const lpl = parseInt(document.getElementById('lpl-slider').value);
            const bil = 550;
            document.getElementById('lpl-val').textContent = lpl;
            const margin = ((bil - lpl) / lpl) * 100;
            const mEl = document.getElementById('margin-val');
            mEl.textContent = margin.toFixed(1) + "%";
            mEl.className = margin >= 20 ? "text-green-600 font-bold" : "text-red-600 font-bold";
            
            if(chartInstance) {
                chartInstance.data.datasets[0].data = [0, lpl*0.5, lpl, lpl, 0];
                chartInstance.update();
            }
        }

        // Init
        selectType('solid');

    </script>
</body>
</html>